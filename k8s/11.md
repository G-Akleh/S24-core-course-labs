# Kubernetes Secrets and Hashicorp Vault

## Kubernetes Secrets and Resource Management

Creating a key through the command: `kubectl create secret generic test-secret --from-literal=username='ghadeer' --from-literal=password='test'`

```bash
secret/devops-secret created
```

Verifying the creation of the key: `kubectl get secret`

```bash
NAME                               TYPE                 DATA   AGE
devops-secret                      Opaque               2      13s
sh.helm.release.v1.python-app.v1   helm.sh/release.v1   1      7d5h
```

Describing the new key: `kubectl describe secret devops-secret`

```bash
Name:         devops-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
username:  7 bytes
password:  4 bytes
```

Decoding the key: `kubectl get secret devops-secret -o jsonpath='{.data}'`

```bash
{"password":"dGVzdA==","username":"Z2hhZGVlcg=="}
```

Decoding the output:

`echo 'dGVzdA==' | base64 --decode`

```bash
test
```

`echo 'Z2hhZGVlcg==' | base64 --decode`

```bash
ghadeer
```

Installing the plugin: `helm plugin install https://github.com/jkroepke/helm-secrets`

```bash
Installed plugin: secrets
```

Then creating a gpg key: `gpg --gen-key`

Using Helm: `helm secrets install python-app-test ./python-chart/ -n default -f ./secrets.yaml`

Viewing po: `kubectl get po`

```bash
NAME                               READY   STATUS      RESTARTS      AGE
post-install-hook                  0/1     Completed   0             2m34s
pre-install-hook                   0/1     Completed   0             2m42s
python-app-test-236fc6943d-3jcb7   1/1     Running     0             2m34s
python-app-6f9978b89-66nkc         1/1     Running     3 (82m ago)   7d5h
```

Verifying the secret: `kubectl exec python-app-test-236fc6943d-3jcb7 -- printenv | grep MY_PASSWORD`

```bash
MY_PASSWORD=secret1234
```

## Vault Secret Management System

After adding and updating Hashicorp repo.

Installing vault: `helm install vault hashicorp/vault --set "server.dev.enabled=true"`

```bash
NAME: vault
LAST DEPLOYED: Wed Apr 17 10:15:21 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

$ helm status vault
$ helm get manifest vault
```

Getting the pods: `kubectl get pods`

```bash
NAME                                   READY   STATUS              RESTARTS      AGE
post-install-hook                      0/1     Completed           0             15m
pre-install-hook                       0/1     Completed           0             15m
python-app-test-236fc6943d-3jcb7       1/1     Running             0             15m
python-app-6f9978b89-66nkc             1/1     Running             3 (95m ago)   7d5h
vault-0                                0/1     ContainerCreating   0             34s
vault-agent-injector-dbfc5cd77-r8tn9   1/1     Running             0             34s
```

- Will be using new secret called another secret created by `` \*

Setting the secret in Vault with the command: `kubectl exec -it vault-0 -- sh`

```bash
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
```

`kubectl exec -it vault-0 -- sh`

```bash
$ kubectl exec -it vault-0 -- sh
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2024-04-17T10:42:23.583137392Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

``

```bash
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2024-04-17T10:42:23.583137392Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

## `exit`

`kubectl exec -it vault-0 -- sh`

```bash
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
```
